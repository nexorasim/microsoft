<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexoraSIM Enterprise Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #ecf0f1;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        body { 
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: var(--card-shadow);
        }
        
        .navbar-brand { 
            font-weight: 600;
            font-size: 1.5rem;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--accent-color) 0%, #2980b9 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 1rem 1.5rem;
            border-bottom: none;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .status-card {
            transition: transform 0.2s ease;
            cursor: pointer;
        }
        
        .status-card:hover {
            transform: translateY(-2px);
        }
        
        .status-badge {
            font-size: 0.85rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .myanmar-text {
            font-family: 'Myanmar Text', 'Pyidaungsu', 'Padauk', sans-serif;
        }
        
        .dashboard-container {
            min-height: 450px;
            background: white;
            border-radius: 8px;
        }
        
        .loading-spinner {
            display: none;
        }
        
        .btn {
            border-radius: 8px;
            font-weight: 500;
            padding: 0.6rem 1.2rem;
        }
        
        .btn-primary {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .btn-primary:hover {
            background: #2980b9;
            border-color: #2980b9;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #ddd;
            padding: 0.6rem 1rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        .alert {
            border-radius: 8px;
            border: none;
        }
        
        .dropdown-menu {
            border-radius: 8px;
            border: none;
            box-shadow: var(--card-shadow);
        }
        
        .nav-link {
            border-radius: 6px;
            margin: 0 0.2rem;
        }
        
        .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-sim-card me-2"></i>NexoraSIM Enterprise
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-language me-1"></i><span id="currentLang">English</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="switchLanguage('en')">English</a></li>
                        <li><a class="dropdown-item myanmar-text" href="#" onclick="switchLanguage('my')">မြန်မာ</a></li>
                    </ul>
                </div>
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i><span data-i18n="logout">Logout</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Device Initialization -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-mobile-alt me-2"></i><span data-i18n="deviceInit">Device Initialization</span></h5>
                    </div>
                    <div class="card-body">
                        <form id="deviceInitForm">
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label" data-i18n="platform">Platform</label>
                                    <select class="form-select" id="platform" required>
                                        <option value="">Select Platform</option>
                                        <option value="Windows">Windows 10/11</option>
                                        <option value="iOS">iOS</option>
                                        <option value="Android">Android</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label" data-i18n="carrier">Carrier</label>
                                    <select class="form-select" id="carrierCode" required>
                                        <option value="">Select Carrier</option>
                                        <option value="MPT">MPT</option>
                                        <option value="ATOM">ATOM</option>
                                        <option value="U9">U9</option>
                                        <option value="MYTEL">MYTEL</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label" data-i18n="iccid">ICCID (Optional)</label>
                                    <input type="text" class="form-control" id="iccid" placeholder="Enter ICCID">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-play me-1"></i><span data-i18n="initialize">Initialize</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                        <div id="initResult" class="mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Dashboard -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center status-card">
                    <div class="card-body">
                        <i class="fas fa-shield-alt fa-3x text-success mb-3"></i>
                        <h6 class="fw-bold" data-i18n="vpnStatus">VPN Status</h6>
                        <span id="vpnStatusBadge" class="badge bg-secondary status-badge">Checking...</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center status-card">
                    <div class="card-body">
                        <i class="fas fa-sim-card fa-3x text-primary mb-3"></i>
                        <h6 class="fw-bold" data-i18n="esimStatus">eSIM Status</h6>
                        <span id="esimStatusBadge" class="badge bg-secondary status-badge">Not Configured</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center status-card">
                    <div class="card-body">
                        <i class="fas fa-cloud fa-3x text-info mb-3"></i>
                        <h6 class="fw-bold" data-i18n="driveStatus">Drive Status</h6>
                        <span id="driveStatusBadge" class="badge bg-secondary status-badge">Checking...</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center status-card">
                    <div class="card-body">
                        <i class="fas fa-check-circle fa-3x text-warning mb-3"></i>
                        <h6 class="fw-bold" data-i18n="complianceStatus">Compliance</h6>
                        <span id="complianceStatusBadge" class="badge bg-secondary status-badge">Checking...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Power BI Dashboard -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i><span data-i18n="analytics">Analytics Dashboard</span></h5>
                    </div>
                    <div class="card-body">
                        <div id="powerBIContainer" class="dashboard-container">
                            <div class="text-center loading-spinner" id="dashboardLoading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2" data-i18n="loadingDashboard">Loading dashboard...</p>
                            </div>
                            <iframe id="powerBIFrame" width="100%" height="400" frameborder="0" style="display: none;"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- eSIM Management (Operator/Admin only) -->
        <div class="row mb-4" id="esimManagement" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-cogs me-2"></i><span data-i18n="esimManagement">eSIM Management</span></h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="activateICCID" placeholder="ICCID">
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="activationCode" placeholder="Activation Code">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="activateCarrier">
                                    <option value="MPT">MPT</option>
                                    <option value="ATOM">ATOM</option>
                                    <option value="U9">U9</option>
                                    <option value="MYTEL">MYTEL</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-success w-100" onclick="activateESIM()">
                                    <i class="fas fa-power-off me-1"></i><span data-i18n="activate">Activate</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/powerbi-client@2.22.0/dist/powerbi.min.js"></script>
    <script>
        // Global variables
        let currentUser = null;
        let accessToken = null;
        let currentLanguage = 'en';

        // Language strings
        const translations = {
            en: {
                deviceInit: "Device Initialization",
                platform: "Platform",
                carrier: "Carrier",
                iccid: "ICCID (Optional)",
                initialize: "Initialize",
                vpnStatus: "VPN Status",
                esimStatus: "eSIM Status",
                driveStatus: "Drive Status",
                complianceStatus: "Compliance",
                analytics: "Analytics Dashboard",
                loadingDashboard: "Loading dashboard...",
                esimManagement: "eSIM Management",
                activate: "Activate",
                logout: "Logout"
            },
            my: {
                deviceInit: "စက်ပစ္စည်း စတင်ခြင်း",
                platform: "ပလပ်ဖောင်း",
                carrier: "ဆက်သွယ်ရေးကုမ္ပဏီ",
                iccid: "ICCID (ရွေးချယ်ခွင့်)",
                initialize: "စတင်မည်",
                vpnStatus: "VPN အခြေအနေ",
                esimStatus: "eSIM အခြေအနေ",
                driveStatus: "Drive အခြေအနေ",
                complianceStatus: "လိုက်နာမှု",
                analytics: "ခွဲခြမ်းစိတ်ဖြာမှု ဒက်ရှ်ဘုတ်",
                loadingDashboard: "ဒက်ရှ်ဘုတ် ဖွင့်နေသည်...",
                esimManagement: "eSIM စီမံခန့်ခွဲမှု",
                activate: "အသုံးပြုမည်",
                logout: "ထွက်မည်"
            }
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeAuth();
            loadUserProfile();
            checkDeviceStatus();
            loadPowerBIDashboard();
        });

        // Authentication
        async function initializeAuth() {
            // Get access token from URL or session storage
            const urlParams = new URLSearchParams(window.location.search);
            accessToken = urlParams.get('token') || sessionStorage.getItem('accessToken');
            
            if (!accessToken) {
                window.location.href = '/login';
                return;
            }
            
            sessionStorage.setItem('accessToken', accessToken);
        }

        // Load user profile and permissions
        async function loadUserProfile() {
            try {
                const response = await fetch('/api/user/profile', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    
                    // Show eSIM management for operators/admins
                    if (currentUser.roles.includes('ESIMOperator') || currentUser.roles.includes('ESIMAdmin')) {
                        document.getElementById('esimManagement').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Failed to load user profile:', error);
            }
        }

        // Device initialization
        document.getElementById('deviceInitForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const deviceId = generateDeviceId();
            const platform = document.getElementById('platform').value;
            const carrierCode = document.getElementById('carrierCode').value;
            const iccid = document.getElementById('iccid').value;
            
            try {
                const response = await fetch('/api/UnifiedPortal/initialize-device', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        deviceId: deviceId,
                        platform: platform,
                        carrierCode: carrierCode,
                        iccid: iccid
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('initResult').innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>Device initialized successfully!
                            ${result.vpnProfileId ? `<br><strong>VPN Profile:</strong> ${result.vpnProfileId}` : ''}
                            ${result.esimProfile ? `<br><strong>eSIM Profile:</strong> ${result.esimProfile.iccid}` : ''}
                        </div>
                    `;
                    checkDeviceStatus();
                } else {
                    document.getElementById('initResult').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>Initialization failed: ${result.error}
                        </div>
                    `;
                }
                
                document.getElementById('initResult').style.display = 'block';
            } catch (error) {
                console.error('Device initialization failed:', error);
            }
        });

        // Check device status
        async function checkDeviceStatus() {
            const deviceId = generateDeviceId();
            
            // Check VPN compliance
            try {
                const vpnResponse = await fetch('/api/UnifiedPortal/vpn/validate-compliance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ deviceId: deviceId })
                });
                
                const vpnResult = await vpnResponse.json();
                updateStatusBadge('vpnStatusBadge', vpnResult.isCompliant ? 'Connected' : 'Disconnected', 
                                vpnResult.isCompliant ? 'success' : 'danger');
            } catch (error) {
                updateStatusBadge('vpnStatusBadge', 'Error', 'danger');
            }
            
            // Simulate other status checks
            updateStatusBadge('driveStatusBadge', 'Registered', 'success');
            updateStatusBadge('complianceStatusBadge', 'Compliant', 'success');
        }

        // Load Power BI dashboard
        async function loadPowerBIDashboard() {
            document.getElementById('dashboardLoading').style.display = 'block';
            
            try {
                const response = await fetch('/api/UnifiedPortal/dashboard-embed', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                const embedConfig = await response.json();
                
                // Configure Power BI embed
                const config = {
                    type: 'report',
                    tokenType: 1, // Embed token
                    accessToken: embedConfig.accessToken,
                    embedUrl: embedConfig.embedUrl,
                    id: embedConfig.reportId,
                    permissions: 1, // Read
                    settings: {
                        filterPaneEnabled: false,
                        navContentPaneEnabled: false
                    }
                };
                
                const reportContainer = document.getElementById('powerBIContainer');
                const report = powerbi.embed(reportContainer, config);
                
                document.getElementById('dashboardLoading').style.display = 'none';
            } catch (error) {
                console.error('Failed to load Power BI dashboard:', error);
                document.getElementById('dashboardLoading').innerHTML = 
                    '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Dashboard temporarily unavailable</div>';
            }
        }

        // eSIM activation
        async function activateESIM() {
            const iccid = document.getElementById('activateICCID').value;
            const activationCode = document.getElementById('activationCode').value;
            const carrierCode = document.getElementById('activateCarrier').value;
            
            if (!iccid || !activationCode) {
                alert('Please enter ICCID and Activation Code');
                return;
            }
            
            try {
                const response = await fetch('/api/UnifiedPortal/esim/activate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        carrierCode: carrierCode,
                        iccid: iccid,
                        activationCode: activationCode
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('eSIM activated successfully!');
                    updateStatusBadge('esimStatusBadge', 'Active', 'success');
                } else {
                    alert('eSIM activation failed: ' + result.error);
                }
            } catch (error) {
                console.error('eSIM activation failed:', error);
                alert('eSIM activation failed');
            }
        }

        // Utility functions
        function generateDeviceId() {
            return sessionStorage.getItem('deviceId') || 
                   (sessionStorage.setItem('deviceId', 'device-' + Math.random().toString(36).substr(2, 9)), 
                    sessionStorage.getItem('deviceId'));
        }

        function updateStatusBadge(elementId, text, type) {
            const badge = document.getElementById(elementId);
            badge.textContent = text;
            badge.className = `badge bg-${type} status-badge`;
        }

        function switchLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('currentLang').textContent = lang === 'en' ? 'English' : 'မြန်မာ';
            
            // Update all translatable elements
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            // Apply Myanmar font class
            if (lang === 'my') {
                document.body.classList.add('myanmar-text');
            } else {
                document.body.classList.remove('myanmar-text');
            }
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = '/logout';
        }
    </script>
</body>
</html>