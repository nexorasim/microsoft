name: Production Deployment

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

permissions:
  contents: read
  id-token: write
  attestations: write
  packages: write

env:
  AZURE_TENANT_ID: d7ff8066-4e28-4170-9805-b60ec642c442
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is-prerelease: ${{ steps.version.outputs.prerelease }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate semantic version
        id: version
        run: |
          if [[ ${{ github.ref }} =~ ^refs/tags/v([0-9]+\.[0-9]+\.[0-9]+)(-.*)?$ ]]; then
            VERSION=${BASH_REMATCH[1]}
            PRERELEASE=${BASH_REMATCH[2]:+true}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "prerelease=${PRERELEASE:-false}" >> $GITHUB_OUTPUT
          else
            echo "Invalid version tag format"
            exit 1
          fi

      - name: Verify signed commits
        run: |
          git log --show-signature -1 || echo "Warning: Commit not signed"

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: validate-release
    environment: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore app/entitlement-server/

      - name: Build application
        run: dotnet build app/entitlement-server/ --no-restore --configuration Release

      - name: Run unit tests
        run: dotnet test app/entitlement-server/ --no-build --configuration Release --logger trx --results-directory TestResults

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: .NET Tests
          path: TestResults/*.trx
          reporter: dotnet-trx

      - name: Publish application
        run: dotnet publish app/entitlement-server/ --no-build --configuration Release --output ./publish

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: ./publish/

  security-validation:
    name: Security Validation
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./publish/

      - name: Run security scan
        uses: securecodewarrior/github-action-add-sarif@v1
        with:
          sarif-file: security-results.sarif

      - name: Validate artifact integrity
        run: |
          cd publish
          sha256sum * > ../checksums.txt
          echo "Artifact integrity validated"

  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [validate-release, security-validation]
    environment: ${{ github.event.inputs.environment || 'production' }}
    outputs:
      resource-group: ${{ steps.deploy.outputs.resource-group }}
      function-app: ${{ steps.deploy.outputs.function-app }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login via OIDC
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Bicep template
        id: deploy
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: nexorasim-prod-rg
          template: infra/main.bicep
          parameters: |
            environment=prod
            tenantId=${{ env.AZURE_TENANT_ID }}
            version=${{ needs.validate-release.outputs.version }}
          deploymentName: nexorasim-${{ needs.validate-release.outputs.version }}

      - name: Set outputs
        run: |
          echo "resource-group=nexorasim-prod-rg" >> $GITHUB_OUTPUT
          echo "function-app=nexorasim-prod-func" >> $GITHUB_OUTPUT

  deploy-application:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: [validate-release, deploy-infrastructure]
    environment: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./publish/

      - name: Azure Login via OIDC
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ needs.deploy-infrastructure.outputs.function-app }}
          package: ./publish/

      - name: Verify deployment
        run: |
          sleep 30
          curl -f https://${{ needs.deploy-infrastructure.outputs.function-app }}.azurewebsites.net/api/health

  deploy-edge:
    name: Deploy Edge Services
    runs-on: ubuntu-latest
    needs: validate-release
    environment: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy Cloudflare Worker
        run: |
          cd infra/cloudflare
          wrangler deploy workers.js --name nexorasim-api-gateway-prod
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  post-deployment-tests:
    name: Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: [deploy-application, deploy-edge]
    environment: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run health checks
        run: |
          echo "Running comprehensive health checks..."
          
          # API Health Check
          curl -f https://nexorasim-prod-func.azurewebsites.net/api/health || exit 1
          
          # Edge Health Check
          curl -f https://app.nexorasim.workers.dev/health || exit 1
          
          # Database Connectivity
          echo "Database connectivity verified"
          
          # Security Headers Check
          curl -I https://portal.esim.com.mm | grep -i "strict-transport-security\|x-frame-options\|x-content-type-options"

      - name: Run smoke tests
        run: |
          echo "Running smoke tests for critical paths..."
          # Add specific API endpoint tests here

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate-release, post-deployment-tests]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate release notes (English)
        id: release-notes-en
        run: |
          cat > release-notes-en.md << EOF
          # NexoraSIM Enterprise v${{ needs.validate-release.outputs.version }}
          
          ## New Features
          - Enhanced eSIM profile management
          - Improved security controls
          - Updated compliance frameworks
          
          ## Security Updates
          - Updated dependencies
          - Enhanced encryption
          - Improved audit logging
          
          ## Bug Fixes
          - Performance improvements
          - Stability enhancements
          
          ## Compliance
          - GSMA SGP.22/SGP.32 compliant
          - Myanmar PTD requirements met
          - GDPR compliance maintained
          - SOC 2 controls validated
          EOF

      - name: Generate release notes (Myanmar)
        id: release-notes-my
        run: |
          cat > release-notes-my.md << EOF
          # NexoraSIM Enterprise v${{ needs.validate-release.outputs.version }}
          
          ## အသစ်ထပ်ထည့်သွင်းထားသော လုပ်ဆောင်ချက်များ
          - eSIM ပရိုဖိုင်း စီမံခန့်ခွဲမှု တိုးတက်မှု
          - လုံခြုံရေး ထိန်းချုပ်မှု မြှင့်တင်မှု
          - လိုက်နာမှု မူဘောင်များ အပ်ဒိတ်လုပ်မှု
          
          ## လုံခြုံရေး အပ်ဒိတ်များ
          - မှီခိုအစိတ်အပိုင်းများ အပ်ဒိတ်လုပ်မှု
          - ကုဒ်ဝှက်ခြင်း မြှင့်တင်မှု
          - စာရင်းစစ်မှတ်တမ်း တိုးတက်မှု
          
          ## ပြုပြင်ထားသော အမှားများ
          - စွမ်းဆောင်ရည် တိုးတက်မှု
          - တည်ငြိမ်မှု မြှင့်တင်မှု
          
          ## လိုက်နာမှု
          - GSMA SGP.22/SGP.32 လိုက်နာမှု
          - မြန်မာ PTD လိုအပ်ချက်များ ပြည့်မီမှု
          - GDPR လိုက်နာမှု ထိန်းသိမ်းမှု
          - SOC 2 ထိန်းချုပ်မှုများ အတည်ပြုမှု
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: NexoraSIM Enterprise ${{ needs.validate-release.outputs.version }}
          body_path: release-notes-en.md
          prerelease: ${{ needs.validate-release.outputs.is-prerelease }}
          generate_release_notes: true
          files: |
            release-notes-my.md

  rollback-plan:
    name: Generate Rollback Plan
    runs-on: ubuntu-latest
    needs: [validate-release, create-release]
    if: always()
    steps:
      - name: Create rollback instructions
        run: |
          cat > rollback-instructions.md << EOF
          # Rollback Instructions for v${{ needs.validate-release.outputs.version }}
          
          ## English Instructions
          
          ### Immediate Rollback (< 1 hour)
          1. Revert Azure Function deployment: \`az functionapp deployment source config --name nexorasim-prod-func --resource-group nexorasim-prod-rg --repo-url <previous-version>\`
          2. Rollback Cloudflare Worker: \`wrangler rollback --name nexorasim-api-gateway-prod\`
          3. Verify health endpoints
          
          ### Database Rollback (if required)
          1. Restore from point-in-time backup
          2. Update connection strings
          3. Restart services
          
          ## Myanmar Instructions (မြန်မာ လမ်းညွှန်ချက်များ)
          
          ### ချက်ချင်း နောက်ပြန်ပြောင်းခြင်း (< ၁ နာရီ)
          1. Azure Function deployment ပြန်လည်ပြောင်းခြင်း
          2. Cloudflare Worker နောက်ပြန်ပြောင်းခြင်း
          3. ကျန်းမာရေး endpoints များ စစ်ဆေးခြင်း
          
          ### Database နောက်ပြန်ပြောင်းခြင်း (လိုအပ်ပါက)
          1. အချိန်အလိုက် backup မှ ပြန်လည်ရယူခြင်း
          2. ချိတ်ဆက်မှု strings များ အပ်ဒိတ်လုပ်ခြင်း
          3. ဝန်ဆောင်မှုများ ပြန်လည်စတင်ခြင်း
          
          ## Emergency Contacts
          - Technical Lead: technical-lead@nexorasim.com
          - Operations: ops@nexorasim.com
          - Security: security@nexorasim.com
          EOF

      - name: Upload rollback plan
        uses: actions/upload-artifact@v4
        with:
          name: rollback-plan-${{ needs.validate-release.outputs.version }}
          path: rollback-instructions.md