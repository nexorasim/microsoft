name: Release Management

on:
  push:
    tags: ['v*']

permissions:
  contents: write
  id-token: write
  attestations: write

env:
  AZURE_TENANT_ID: d7ff8066-4e28-4170-9805-b60ec642c442

jobs:
  validate-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Validate SemVer
        id: version
        run: |
          if [[ ${{ github.ref }} =~ ^refs/tags/v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            echo "version=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          else
            exit 1
          fi

  build-artifacts:
    needs: validate-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'
      - name: Build and publish
        run: |
          dotnet publish app/entitlement-server/ -c Release -o ./artifacts/
          cd artifacts && sha256sum * > ../checksums.txt
      - name: Generate SBOM
        run: |
          dotnet tool install --global Microsoft.Sbom.Tool
          sbom-tool generate -b ./artifacts/ -bc ./artifacts/ -pn "NexoraSIM-Enterprise" -pv "${{ needs.validate-release.outputs.version }}" -ps "NexoraCore"
      - name: Attest artifacts
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: './artifacts/*'
      - uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            ./artifacts/
            checksums.txt
            _manifest/

  create-release:
    needs: [validate-release, build-artifacts]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate English release notes
        run: |
          cat > release-notes-en.md << 'EOF'
          # NexoraSIM Enterprise v${{ needs.validate-release.outputs.version }}
          
          ## New Features
          - Enhanced eSIM profile management capabilities
          - Improved security controls and audit logging
          - Updated compliance frameworks for Myanmar PTD requirements
          
          ## Security Updates
          - Updated dependencies to latest secure versions
          - Enhanced encryption and key management
          - Improved access control mechanisms
          
          ## Bug Fixes
          - Performance optimizations for large-scale deployments
          - Stability improvements for carrier integrations
          - Enhanced error handling and recovery
          
          ## Compliance
          - GSMA SGP.22/SGP.32 fully compliant
          - Myanmar PTD telecommunications requirements met
          - GDPR data protection controls validated
          - SOC 2 Type II security controls implemented
          
          ## Deployment
          - Zero-downtime deployment supported
          - Automated rollback procedures available
          - Comprehensive health checks included
          EOF
      - name: Generate Myanmar release notes
        run: |
          cat > release-notes-my.md << 'EOF'
          # NexoraSIM Enterprise v${{ needs.validate-release.outputs.version }}
          
          ## အသစ်ထပ်ထည့်သွင်းထားသော လုပ်ဆောင်ချက်များ
          - eSIM ပရိုဖိုင်း စီမံခန့်ခွဲမှု စွမ်းရည်များ မြှင့်တင်မှု
          - လုံခြုံရေး ထိန်းချုပ်မှုများနှင့် စာရင်းစစ်မှတ်တမ်းများ တိုးတက်မှု
          - မြန်မာ PTD လိုအပ်ချက်များအတွက် လိုက်နာမှု မူဘောင်များ အပ်ဒိတ်လုပ်မှု
          
          ## လုံခြုံရေး အပ်ဒိတ်များ
          - မှီခိုအစိတ်အပိုင်းများကို နောက်ဆုံး လုံခြုံသော ဗားရှင်းများသို့ အပ်ဒိတ်လုပ်မှု
          - ကုဒ်ဝှက်ခြင်းနှင့် သော့ချက် စီမံခန့်ခွဲမှု မြှင့်တင်မှု
          - ဝင်ရောက်ခွင့် ထိန်းချုပ်မှု ယန္တရားများ တိုးတက်မှု
          
          ## ပြုပြင်ထားသော အမှားများ
          - ကြီးမားသော အသုံးချမှုများအတွက် စွမ်းဆောင်ရည် အကောင်းဆုံးဖြစ်အောင်လုပ်မှု
          - ဆက်သွယ်ရေးကုမ္ပဏီ ချိတ်ဆက်မှုများ တည်ငြိမ်မှု တိုးတက်မှု
          - အမှား ကိုင်တွယ်မှုနှင့် ပြန်လည်ရယူမှု မြှင့်တင်မှု
          
          ## လိုက်နာမှု
          - GSMA SGP.22/SGP.32 အပြည့်အဝ လိုက်နာမှု
          - မြန်မာ PTD ဆက်သွယ်ရေး လိုအပ်ချက်များ ပြည့်မီမှု
          - GDPR ဒေတာ ကာကွယ်မှု ထိန်းချုပ်မှုများ အတည်ပြုမှု
          - SOC 2 Type II လုံခြုံရေး ထိန်းချုပ်မှုများ အကောင်အထည်ဖော်မှု
          
          ## အသုံးချမှု
          - အချိန်မရပ်တန့် အသုံးချမှု ပံ့ပိုးမှု
          - အလိုအလျောက် နောက်ပြန်ပြောင်းမှု လုပ်ငန်းစဉ်များ ရရှိနိုင်မှု
          - ပြည့်စုံသော ကျန်းမာရေး စစ်ဆေးမှုများ ပါဝင်မှု
          EOF
      - uses: actions/download-artifact@v4
        with:
          name: release-artifacts
      - uses: softprops/action-gh-release@v1
        with:
          name: NexoraSIM Enterprise ${{ needs.validate-release.outputs.version }}
          body_path: release-notes-en.md
          files: |
            artifacts/*
            checksums.txt
            _manifest/*
            release-notes-my.md