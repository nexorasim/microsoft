name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write
  id-token: write
  checks: write
  pull-requests: write

env:
  AZURE_TENANT_ID: d7ff8066-4e28-4170-9805-b60ec642c442

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run SAST Scan
        uses: github/super-linter@v5
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_CSHARP: true
          VALIDATE_JAVASCRIPT_ES: true
          
      - name: Scan for Secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

  build-functions:
    needs: security-scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
          
      - name: Build
        run: dotnet build app/entitlement-server/ --configuration Release
        
      - name: Publish
        run: dotnet publish app/entitlement-server/ --configuration Release --output ./publish
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: function-app
          path: ./publish

  deploy-infrastructure:
    needs: security-scan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login via OIDC
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          
      - name: Deploy Infrastructure
        uses: azure/arm-deploy@v2
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: nexorasim-prod-rg
          template: infra/main.bicep
          parameters: |
            environment=prod
            tenantId=${{ env.AZURE_TENANT_ID }}

  deploy-functions:
    needs: [build-functions, deploy-infrastructure]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: function-app
          path: ./publish
          
      - name: Azure Login via OIDC
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          
      - name: Deploy Function App
        uses: Azure/functions-action@v1
        with:
          app-name: nexorasim-prod-func
          package: ./publish

  deploy-cloudflare:
    needs: security-scan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Wrangler
        run: npm install -g wrangler
        
      - name: Deploy Worker
        run: |
          cd infra/cloudflare
          wrangler deploy workers.js --name nexorasim-api-gateway
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  post-deployment-tests:
    needs: [deploy-functions, deploy-cloudflare]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Health Check Tests
        run: |
          curl -f https://nexorasim-prod-func.azurewebsites.net/api/health || exit 1
          curl -f https://app.nexorasim.workers.dev/health || exit 1